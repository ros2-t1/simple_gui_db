<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œë´‡ ìƒíƒœ ë””ë²„ê·¸ ë„êµ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .robot-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            display: inline-block;
            vertical-align: top;
            width: 300px;
            background: white;
        }
        
        .robot-card.idle {
            border-color: #28a745;
        }
        
        .robot-card.busy {
            border-color: #ffc107;
        }
        
        .robot-card.waiting {
            border-color: #17a2b8;
        }
        
        .robot-card.error {
            border-color: #dc3545;
        }
        
        .robot-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .status-info {
            margin: 10px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input, button {
            padding: 8px;
            margin: 2px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .danger-btn {
            background: #dc3545;
        }
        
        .danger-btn:hover {
            background: #c82333;
        }
        
        .success-btn {
            background: #28a745;
        }
        
        .success-btn:hover {
            background: #218838;
        }
        
        .warning-btn {
            background: #ffc107;
            color: black;
        }
        
        .warning-btn:hover {
            background: #e0a800;
        }
        
        .task-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .logs {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .scenario-btn {
            padding: 10px 15px;
            background: #6f42c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .scenario-btn:hover {
            background: #563d7c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ë¡œë´‡ ìƒíƒœ ë””ë²„ê·¸ ë„êµ¬</h1>
        <p>ì‹¤ì œ ë¡œë´‡ ì—†ì´ ë¡œë´‡ ìƒíƒœë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¡°ì‘í•˜ì—¬ í”Œë¦¿ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <!-- Global Actions -->
        <div class="debug-panel">
            <h2>ğŸ“Š ì „ì²´ ì‹œìŠ¤í…œ ì œì–´</h2>
            <div class="quick-actions">
                <button onclick="refreshAllStates()" class="success-btn">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
                <button onclick="resetAllRobots()" class="warning-btn">ëª¨ë“  ë¡œë´‡ ì´ˆê¸°í™”</button>
                <button onclick="simulateDeliveryScenario()" class="scenario-btn">ë°°ë‹¬ ì‹œë‚˜ë¦¬ì˜¤</button>
                <button onclick="simulateCallScenario()" class="scenario-btn">í˜¸ì¶œ ì‹œë‚˜ë¦¬ì˜¤</button>
                <button onclick="simulateMultiRobot()" class="scenario-btn">ë‹¤ì¤‘ ë¡œë´‡ í…ŒìŠ¤íŠ¸</button>
            </div>
        </div>
        
        <!-- Robot Cards -->
        <div id="robot-container">
            <!-- Robot cards will be dynamically generated -->
        </div>
        
        <!-- Task Management -->
        <div class="debug-panel">
            <h2>ğŸ“‹ ì‘ì—… ê´€ë¦¬</h2>
            <div id="task-container">
                <!-- Active tasks will be shown here -->
            </div>
            <div class="control-group">
                <label>í…ŒìŠ¤íŠ¸ ì‘ì—… ìƒì„±:</label>
                <select id="test-task-type">
                    <option value="ë°°ë‹¬">ë°°ë‹¬</option>
                    <option value="í˜¸ì¶œ">í˜¸ì¶œ</option>
                </select>
                <input type="number" id="test-resident-id" placeholder="ì£¼ë¯¼ ID" value="9999">
                <button onclick="createTestTask()">í…ŒìŠ¤íŠ¸ ì‘ì—… ìƒì„±</button>
            </div>
        </div>
        
        <!-- Logs -->
        <div class="debug-panel">
            <h2>ğŸ“œ ë””ë²„ê·¸ ë¡œê·¸</h2>
            <div id="debug-logs" class="logs"></div>
            <button onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        let robots = {};
        let activeTasks = [];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllStates();
            setInterval(refreshAllStates, 3000); // Auto refresh every 3 seconds
        });
        
        function log(message) {
            const logsDiv = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
        }
        
        async function refreshAllStates() {
            try {
                // Get robot states
                const robotResponse = await fetch('/robot_status');
                const robotData = await robotResponse.json();
                
                if (robotData.success) {
                    robots = robotData.robots;
                    renderRobotCards();
                }
                
                // Get active tasks
                const tasksResponse = await fetch('/debug/active_tasks');
                const tasksData = await tasksResponse.json();
                
                if (tasksData.success) {
                    activeTasks = tasksData.tasks;
                    renderActiveTasks();
                }
                
            } catch (error) {
                log(`âŒ Error refreshing states: ${error.message}`);
            }
        }
        
        function renderRobotCards() {
            const container = document.getElementById('robot-container');
            container.innerHTML = '';
            
            Object.keys(robots).forEach(robotId => {
                const robot = robots[robotId];
                const card = createRobotCard(robotId, robot);
                container.appendChild(card);
            });
        }
        
        function createRobotCard(robotId, robot) {
            const div = document.createElement('div');
            div.className = `robot-card ${getRobotCardClass(robot.status)}`;
            
            div.innerHTML = `
                <div class="robot-title">ğŸ¤– ${robotId}</div>
                <div class="status-info">
                    <strong>ìƒíƒœ:</strong> ${robot.status}<br>
                    <strong>ì‘ì—… ID:</strong> ${robot.current_task_id || 'ì—†ìŒ'}<br>
                    <strong>ìµœì¢… ì—…ë°ì´íŠ¸:</strong> ${new Date(robot.last_update * 1000).toLocaleTimeString()}
                </div>
                
                <div class="control-group">
                    <label>ìƒíƒœ ë³€ê²½:</label>
                    <select id="status-${robotId}">
                        <option value="idle" ${robot.status === 'idle' ? 'selected' : ''}>ëŒ€ê¸° (idle)</option>
                        <option value="moving_to_arm" ${robot.status === 'moving_to_arm' ? 'selected' : ''}>ì•„ì´í…œìœ¼ë¡œ ì´ë™</option>
                        <option value="picking" ${robot.status === 'picking' ? 'selected' : ''}>ì§‘ê¸° ì¤‘</option>
                        <option value="moving_to_user" ${robot.status === 'moving_to_user' ? 'selected' : ''}>ì‚¬ìš©ìë¡œ ì´ë™</option>
                        <option value="waiting_confirm" ${robot.status === 'waiting_confirm' ? 'selected' : ''}>ìˆ˜ë ¹ ëŒ€ê¸°</option>
                        <option value="returning_to_dock" ${robot.status === 'returning_to_dock' ? 'selected' : ''}>ë„í‚¹ ë³µê·€</option>
                        <option value="error" ${robot.status === 'error' ? 'selected' : ''}>ì˜¤ë¥˜</option>
                    </select>
                    <button onclick="updateRobotStatus('${robotId}')">ìƒíƒœ ì—…ë°ì´íŠ¸</button>
                </div>
                
                <div class="control-group">
                    <label>ì‘ì—… ID ì„¤ì •:</label>
                    <input type="number" id="task-${robotId}" value="${robot.current_task_id || ''}" placeholder="ì‘ì—… ID">
                    <button onclick="updateTaskId('${robotId}')">ì‘ì—… ID ì„¤ì •</button>
                </div>
                
                <div class="quick-actions">
                    <button onclick="simulatePickup('${robotId}')" class="scenario-btn">í”½ì—… ì‹œë®¬ë ˆì´ì…˜</button>
                    <button onclick="simulateDelivery('${robotId}')" class="scenario-btn">ë°°ë‹¬ ì‹œë®¬ë ˆì´ì…˜</button>
                    ${robot.status === 'waiting_confirm' ? '<button onclick="confirmDelivery(\''+robotId+'\')" class="success-btn">âœ… í™•ì¸ ì™„ë£Œ</button>' : ''}
                    <button onclick="resetRobot('${robotId}')" class="danger-btn">ë¡œë´‡ ë¦¬ì…‹</button>
                </div>
            `;
            
            return div;
        }
        
        function getRobotCardClass(status) {
            if (status === 'idle') return 'idle';
            if (status === 'waiting_confirm') return 'waiting';
            if (status === 'error') return 'error';
            return 'busy';
        }
        
        function renderActiveTasks() {
            const container = document.getElementById('task-container');
            container.innerHTML = '';
            
            if (activeTasks.length === 0) {
                container.innerHTML = '<p>í™œì„± ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            activeTasks.forEach(task => {
                const div = document.createElement('div');
                div.className = 'task-info';
                div.innerHTML = `
                    <strong>ì‘ì—… ${task.task_id}</strong> - ${task.task_type} 
                    (ì£¼ë¯¼ ${task.requester_resident_id}) 
                    | ìƒíƒœ: ${task.status} 
                    | ë¡œë´‡: ${task.assigned_bot_id || 'ë¯¸í• ë‹¹'}
                    <button onclick="updateTaskStatus(${task.task_id}, 'ì™„ë£Œ')" style="margin-left: 10px;">ì™„ë£Œ ì²˜ë¦¬</button>
                    <button onclick="updateTaskStatus(${task.task_id}, 'ì‹¤íŒ¨')" class="danger-btn" style="margin-left: 5px;">ì‹¤íŒ¨ ì²˜ë¦¬</button>
                `;
                container.appendChild(div);
            });
        }
        
        async function updateRobotStatus(robotId) {
            const newStatus = document.getElementById(`status-${robotId}`).value;
            
            try {
                const response = await fetch(`/debug/robot_status/${robotId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… ${robotId} ìƒíƒœë¥¼ ${newStatus}ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
                    refreshAllStates();
                } else {
                    log(`âŒ ${robotId} ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function updateTaskId(robotId) {
            const taskId = document.getElementById(`task-${robotId}`).value;
            
            try {
                const response = await fetch(`/debug/robot_task/${robotId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId || null })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… ${robotId} ì‘ì—… IDë¥¼ ${taskId || 'ì—†ìŒ'}ìœ¼ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`);
                    refreshAllStates();
                } else {
                    log(`âŒ ${robotId} ì‘ì—… ID ì„¤ì • ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function resetRobot(robotId) {
            if (!confirm(`${robotId}ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const response = await fetch(`/debug/robot_reset/${robotId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… ${robotId}ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.`);
                    refreshAllStates();
                } else {
                    log(`âŒ ${robotId} ì´ˆê¸°í™” ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function resetAllRobots() {
            if (!confirm('ëª¨ë“  ë¡œë´‡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            for (let robotId of Object.keys(robots)) {
                await resetRobot(robotId);
            }
            log('âœ… ëª¨ë“  ë¡œë´‡ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
        }
        
        async function createTestTask() {
            const taskType = document.getElementById('test-task-type').value;
            const residentId = document.getElementById('test-resident-id').value;
            
            if (!residentId) {
                alert('ì£¼ë¯¼ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/debug/create_test_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        task_type: taskType, 
                        resident_id: parseInt(residentId)
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… í…ŒìŠ¤íŠ¸ ì‘ì—…ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤: ${result.task_id}`);
                    refreshAllStates();
                } else {
                    log(`âŒ í…ŒìŠ¤íŠ¸ ì‘ì—… ìƒì„± ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        async function updateTaskStatus(taskId, status) {
            try {
                const response = await fetch(`/debug/task_status/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… ì‘ì—… ${taskId} ìƒíƒœë¥¼ ${status}ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.`);
                    refreshAllStates();
                } else {
                    log(`âŒ ì‘ì—… ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // Simulation scenarios
        async function simulatePickup(robotId) {
            log(`ğŸ¬ ${robotId} í”½ì—… ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...`);
            
            await updateRobotStatusDirect(robotId, 'moving_to_arm');
            await sleep(2000);
            
            await updateRobotStatusDirect(robotId, 'picking');
            await sleep(3000);
            
            await updateRobotStatusDirect(robotId, 'moving_to_user');
            await sleep(2000);
            
            await updateRobotStatusDirect(robotId, 'waiting_confirm');
            log(`âœ… ${robotId} í”½ì—… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ - ìˆ˜ë ¹ ëŒ€ê¸° ì¤‘`);
        }
        
        async function simulateDelivery(robotId) {
            log(`ğŸ¬ ${robotId} ë°°ë‹¬ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...`);
            
            await updateRobotStatusDirect(robotId, 'waiting_confirm');
            await sleep(3000);
            
            await updateRobotStatusDirect(robotId, 'returning_to_dock');
            await sleep(2000);
            
            await updateRobotStatusDirect(robotId, 'idle');
            log(`âœ… ${robotId} ë°°ë‹¬ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ`);
        }
        
        async function simulateDeliveryScenario() {
            log('ğŸ¬ ì „ì²´ ë°°ë‹¬ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...');
            await createTestTask();
            await sleep(1000);
            await simulatePickup('robot_1');
        }
        
        async function simulateCallScenario() {
            log('ğŸ¬ í˜¸ì¶œ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...');
            document.getElementById('test-task-type').value = 'í˜¸ì¶œ';
            await createTestTask();
            await sleep(1000);
            await updateRobotStatusDirect('robot_1', 'moving_to_user');
            await sleep(3000);
            await updateRobotStatusDirect('robot_1', 'waiting_confirm');
        }
        
        async function simulateMultiRobot() {
            log('ğŸ¬ ë‹¤ì¤‘ ë¡œë´‡ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘...');
            
            // Robot 1: ë°°ë‹¬
            document.getElementById('test-task-type').value = 'ë°°ë‹¬';
            await createTestTask();
            await sleep(500);
            simulatePickup('robot_1');
            
            // Robot 2: í˜¸ì¶œ
            document.getElementById('test-task-type').value = 'í˜¸ì¶œ';
            document.getElementById('test-resident-id').value = '9998';
            await createTestTask();
            await sleep(500);
            updateRobotStatusDirect('robot_2', 'moving_to_user');
            
            log('âœ… ë‹¤ì¤‘ ë¡œë´‡ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ ì¤‘...');
        }
        
        async function updateRobotStatusDirect(robotId, status) {
            const response = await fetch(`/debug/robot_status/${robotId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            refreshAllStates();
        }
        
        async function confirmDelivery(robotId) {
            log(`ğŸ¯ ${robotId} ë°°ë‹¬ í™•ì¸ ì™„ë£Œ ì²˜ë¦¬ ì¤‘...`);
            
            try {
                const response = await fetch(`/debug/complete_delivery/${robotId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… ${robotId} ë°°ë‹¬ ì™„ë£Œ: Task ${result.completed_task_id} ì²˜ë¦¬ë¨`);
                    refreshAllStates();
                } else {
                    log(`âŒ ${robotId} ë°°ë‹¬ ì™„ë£Œ ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                log(`âŒ ë°°ë‹¬ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>